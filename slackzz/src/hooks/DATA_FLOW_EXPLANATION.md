# å®Œæ•´æ•°æ®æµè¯´æ˜

## ğŸ“Š æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜èŠå¤©åº”ç”¨ä¸­ä»ç”¨æˆ·æ“ä½œåˆ° UI æ›´æ–°çš„å®Œæ•´æ•°æ®æµï¼ŒåŒ…æ‹¬ HTTP è¯·æ±‚ã€æ•°æ®åº“æ“ä½œã€Socket.IO å¹¿æ’­å’Œ React Query ç¼“å­˜æ›´æ–°ã€‚

---

## ğŸ”„ åœºæ™¯ 1: å‘é€æ–°æ¶ˆæ¯

### å®Œæ•´æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 1: ç”¨æˆ·æ“ä½œï¼ˆå‰ç«¯ï¼‰                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Alice åœ¨èŠå¤©æ¡†è¾“å…¥ "Hello" å¹¶ç‚¹å‡»å‘é€
  â†“
text-editor.tsx å‘é€ HTTP POST è¯·æ±‚
  â†“
axios.post('/api/web-socket/messages', { content: 'Hello' })

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 2: æœåŠ¡å™¨å¤„ç†ï¼ˆåç«¯ï¼‰                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
æ¥æ”¶è¯·æ±‚ â†’ messages/index.ts
  â†“
1. éªŒè¯ç”¨æˆ·èº«ä»½ âœ…
2. ä¿å­˜åˆ°æ•°æ®åº“ âœ…
   INSERT INTO messages (content, user_id, channel_id)
   VALUES ('Hello', 'alice-id', 'channel-123')
  â†“
3. æŸ¥è¯¢åˆšæ’å…¥çš„æ¶ˆæ¯ï¼ˆåŒ…å«ç”¨æˆ·ä¿¡æ¯ï¼‰
   data = {
     id: 'msg-456',
     content: 'Hello',
     user_id: { id: 'alice-id', name: 'Alice', ... },
     channel_id: 'channel-123',
     ...
   }

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 3: Socket.IO å¹¿æ’­ï¼ˆæœåŠ¡å™¨ï¼‰                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
io.emit('channel:channel-123:channel-messages', data)
  â†“
ğŸ“¡ å¹¿æ’­ç»™æ‰€æœ‰è¿æ¥çš„å®¢æˆ·ç«¯

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 4: å‰ç«¯æ¥æ”¶ï¼ˆSocket.IOï¼‰                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
useChatSocketConnection hook
  â†“
socket.on('channel:channel-123:channel-messages', handleNewMessage)
  â†“
æ”¶åˆ°äº‹ä»¶ï¼data = { id: 'msg-456', content: 'Hello', ... }

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 5: æ›´æ–°ç¼“å­˜ï¼ˆReact Queryï¼‰                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
handleNewMessage(data) è¢«è°ƒç”¨
  â†“
queryClient.setQueryData(['channel:channel-123', 'channel-123'], ...)
  â†“
æ‰¾åˆ°ç¼“å­˜ï¼šprev = { pages: [{ data: [æ—§æ¶ˆæ¯1, æ—§æ¶ˆæ¯2] }] }
  â†“
æ›´æ–°ç¼“å­˜ï¼š{ pages: [{ data: [æ–°æ¶ˆæ¯, æ—§æ¶ˆæ¯1, æ—§æ¶ˆæ¯2] }] }

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 6: UI è‡ªåŠ¨æ›´æ–°ï¼ˆReactï¼‰                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
React Query æ£€æµ‹åˆ°ç¼“å­˜å˜åŒ–
  â†“
chat-messages.tsx è‡ªåŠ¨é‡æ–°æ¸²æŸ“
  â†“
æ˜¾ç¤ºæ–°æ¶ˆæ¯ "Hello" âœ…
```

---

## ğŸ”„ åœºæ™¯ 2: ç¼–è¾‘æ¶ˆæ¯

### å®Œæ•´æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 1: ç”¨æˆ·æ“ä½œï¼ˆå‰ç«¯ï¼‰                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Alice ç¼–è¾‘æ¶ˆæ¯ "Hello" â†’ "Hello World"
  â†“
chat-item.tsx å‘é€ HTTP PATCH è¯·æ±‚
  â†“
axios.patch('/api/web-socket/messages/msg-456', { content: 'Hello World' })

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 2: æœåŠ¡å™¨å¤„ç†ï¼ˆåç«¯ï¼‰                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
æ¥æ”¶è¯·æ±‚ â†’ messages/[messageId].ts
  â†“
1. éªŒè¯ç”¨æˆ·èº«ä»½ âœ…
2. éªŒè¯æƒé™ï¼ˆåªæœ‰æ¶ˆæ¯æ‰€æœ‰è€…å¯ä»¥ç¼–è¾‘ï¼‰âœ…
3. æ›´æ–°æ•°æ®åº“ âœ…
   UPDATE messages SET content = 'Hello World' WHERE id = 'msg-456'
  â†“
4. æŸ¥è¯¢æ›´æ–°åçš„æ¶ˆæ¯
   updatedMessage = {
     id: 'msg-456',
     content: 'Hello World',  // â† å·²æ›´æ–°
     user_id: { ... },
     ...
   }

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 3: Socket.IO å¹¿æ’­ï¼ˆæœåŠ¡å™¨ï¼‰                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
io.emit('channel:channel-123:channel-messages:update', updatedMessage)
  â†“
ğŸ“¡ å¹¿æ’­ç»™æ‰€æœ‰è¿æ¥çš„å®¢æˆ·ç«¯

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 4: å‰ç«¯æ¥æ”¶ï¼ˆSocket.IOï¼‰                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
socket.on('channel:channel-123:channel-messages:update', handleUpdateMessage)
  â†“
æ”¶åˆ°äº‹ä»¶ï¼updatedMessage = { id: 'msg-456', content: 'Hello World', ... }

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 5: æ›´æ–°ç¼“å­˜ï¼ˆReact Queryï¼‰                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
handleUpdateMessage(updatedMessage) è¢«è°ƒç”¨
  â†“
queryClient.setQueryData(['channel:channel-123', 'channel-123'], ...)
  â†“
æ‰¾åˆ°ç¼“å­˜ï¼šprev = { pages: [{ data: [msg1, msg-456: 'Hello', msg2] }] }
  â†“
éå†æ‰€æœ‰é¡µé¢ï¼Œæ‰¾åˆ° id === 'msg-456' çš„æ¶ˆæ¯
  â†“
æ›¿æ¢ï¼š{ pages: [{ data: [msg1, msg-456: 'Hello World', msg2] }] }

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 6: UI è‡ªåŠ¨æ›´æ–°ï¼ˆReactï¼‰                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
React Query æ£€æµ‹åˆ°ç¼“å­˜å˜åŒ–
  â†“
chat-messages.tsx è‡ªåŠ¨é‡æ–°æ¸²æŸ“
  â†“
æ˜¾ç¤ºæ›´æ–°åçš„æ¶ˆæ¯ "Hello World" âœ…
```

---

## ğŸ“‹ å…³é”®æ•°æ®æµå›¾

### å‘é€æ–°æ¶ˆæ¯

```
å‰ç«¯ (text-editor.tsx)
  â†“ HTTP POST
åç«¯ (messages/index.ts)
  â†“ ä¿å­˜æ•°æ®åº“
æ•°æ®åº“ (Supabase)
  â†“ è¿”å›æ•°æ®
åç«¯
  â†“ Socket.IO emit
Socket.IO æœåŠ¡å™¨
  â†“ å¹¿æ’­äº‹ä»¶
å‰ç«¯ (useChatSocketConnection)
  â†“ handleNewMessage
React Query ç¼“å­˜
  â†“ æ›´æ–°ç¼“å­˜
UI (chat-messages.tsx)
  â†“ é‡æ–°æ¸²æŸ“
æ˜¾ç¤ºæ–°æ¶ˆæ¯ âœ…
```

### æ›´æ–°æ¶ˆæ¯

```
å‰ç«¯ (chat-item.tsx)
  â†“ HTTP PATCH
åç«¯ (messages/[messageId].ts)
  â†“ æ›´æ–°æ•°æ®åº“
æ•°æ®åº“ (Supabase)
  â†“ è¿”å›æ•°æ®
åç«¯
  â†“ Socket.IO emit
Socket.IO æœåŠ¡å™¨
  â†“ å¹¿æ’­äº‹ä»¶
å‰ç«¯ (useChatSocketConnection)
  â†“ handleUpdateMessage
React Query ç¼“å­˜
  â†“ æ›´æ–°ç¼“å­˜
UI (chat-messages.tsx)
  â†“ é‡æ–°æ¸²æŸ“
æ˜¾ç¤ºæ›´æ–°åçš„æ¶ˆæ¯ âœ…
```

---

## ğŸ”‘ è¾“å…¥è¾“å‡ºæ€»ç»“

### è¾“å…¥ï¼ˆå‰ç«¯ â†’ åç«¯ï¼‰

| æ“ä½œ | è¾“å…¥ | è·¯å¾„ |
|------|------|------|
| å‘é€æ¶ˆæ¯ | `{ content: 'Hello' }` | `POST /api/web-socket/messages` |
| ç¼–è¾‘æ¶ˆæ¯ | `{ content: 'Hello World' }` | `PATCH /api/web-socket/messages/msg-456` |
| åˆ é™¤æ¶ˆæ¯ | æ—  body | `DELETE /api/web-socket/messages/msg-456` |

### è¾“å‡ºï¼ˆåç«¯ â†’ å‰ç«¯ï¼‰

| æ“ä½œ | Socket.IO äº‹ä»¶å | è¾“å‡ºæ•°æ® |
|------|----------------|---------|
| å‘é€æ¶ˆæ¯ | `channel:channel-123:channel-messages` | `{ id, content, user_id, ... }` |
| æ›´æ–°æ¶ˆæ¯ | `channel:channel-123:channel-messages:update` | `{ id, content: 'Updated', ... }` |

### å‰ç«¯å¤„ç†

| Socket äº‹ä»¶ | å¤„ç†å‡½æ•° | æ›´æ–°æ“ä½œ |
|------------|---------|---------|
| `addKey` | `handleNewMessage` | åœ¨ç¬¬ä¸€é¡µå¼€å¤´æ·»åŠ æ–°æ¶ˆæ¯ |
| `updateKey` | `handleUpdateMessage` | åœ¨æ‰€æœ‰é¡µé¢ä¸­æ‰¾åˆ°å¹¶æ›´æ–°æ¶ˆæ¯ |

---

## ğŸ¯ å…³é”®ç»„ä»¶è¯´æ˜

### 1. useChatFetcher

**ä½œç”¨**ï¼šåˆå§‹åŠ è½½æ¶ˆæ¯æ•°æ®

```typescript
// ä½¿ç”¨ useInfiniteQuery ä» API è·å–æ¶ˆæ¯
const { data } = useChatFetcher({
  queryKey: 'channel:channel-123',
  apiUrl: '/api/messages',
  paramValue: 'channel-123',
  pageSize: 10
});

// æ•°æ®ç»“æ„
data = {
  pages: [
    { data: [msg1, msg2, ...] },  // ç¬¬1é¡µ
    { data: [msg11, msg12, ...] } // ç¬¬2é¡µ
  ]
}
```

**æ•°æ®æµ**ï¼š
```
API è¯·æ±‚ â†’ è¿”å›æ•°æ® â†’ React Query ç¼“å­˜ â†’ UI æ˜¾ç¤º
```

---

### 2. useChatSocketConnection

**ä½œç”¨**ï¼šç›‘å¬ Socket.IO äº‹ä»¶ï¼Œå®æ—¶æ›´æ–°ç¼“å­˜

```typescript
// ç›‘å¬æ–°æ¶ˆæ¯
socket.on('channel:channel-123:channel-messages', handleNewMessage);
// ç›‘å¬æ¶ˆæ¯æ›´æ–°
socket.on('channel:channel-123:channel-messages:update', handleUpdateMessage);
```

**æ•°æ®æµ**ï¼š
```
Socket.IO äº‹ä»¶ â†’ handleNewMessage/handleUpdateMessage â†’ æ›´æ–°ç¼“å­˜ â†’ UI è‡ªåŠ¨æ›´æ–°
```

---

### 3. handleNewMessage

**è¾“å…¥**ï¼š`message: MessageWithUser`ï¼ˆæ–°æ¶ˆæ¯å¯¹è±¡ï¼‰

**å¤„ç†**ï¼š
1. æ‰¾åˆ°ç¼“å­˜ï¼š`queryClient.setQueryData([queryKey, paramValue], ...)`
2. åœ¨ç¬¬ä¸€é¡µå¼€å¤´æ·»åŠ ï¼š`data: [message, ...newPages[0].data]`
3. è¿”å›æ›´æ–°åçš„æ•°æ®

**è¾“å‡º**ï¼šæ›´æ–°åçš„ç¼“å­˜æ•°æ®

---

### 4. handleUpdateMessage

**è¾“å…¥**ï¼š`message: any`ï¼ˆæ›´æ–°åçš„æ¶ˆæ¯å¯¹è±¡ï¼‰

**å¤„ç†**ï¼š
1. æ‰¾åˆ°ç¼“å­˜ï¼š`queryClient.setQueryData([queryKey, paramValue], ...)`
2. éå†æ‰€æœ‰é¡µé¢ï¼š`prev.pages.map(...)`
3. éå†æ¯é¡µæ¶ˆæ¯ï¼š`page.data.map(...)`
4. æ‰¾åˆ°åŒ¹é…çš„æ¶ˆæ¯ï¼š`if (data.id === message.id)`
5. æ›¿æ¢ä¸ºæ›´æ–°åçš„æ¶ˆæ¯ï¼š`return message`
6. è¿”å›æ›´æ–°åçš„æ•°æ®

**è¾“å‡º**ï¼šæ›´æ–°åçš„ç¼“å­˜æ•°æ®

---

## ğŸ” æ•°æ®æµå…³é”®ç‚¹

### 1. åˆå§‹åŠ è½½

```
ç»„ä»¶æŒ‚è½½
  â†“
useChatFetcher è°ƒç”¨
  â†“
axios.get('/api/messages?channelId=channel-123')
  â†“
æœåŠ¡å™¨è¿”å›æ•°æ®
  â†“
React Query å­˜å…¥ç¼“å­˜
  â†“
UI æ˜¾ç¤ºæ¶ˆæ¯
```

### 2. å®æ—¶æ›´æ–°ï¼ˆæ–°æ¶ˆæ¯ï¼‰

```
æœåŠ¡å™¨ä¿å­˜æ¶ˆæ¯
  â†“
Socket.IO å¹¿æ’­
  â†“
å‰ç«¯æ”¶åˆ°äº‹ä»¶
  â†“
handleNewMessage æ›´æ–°ç¼“å­˜
  â†“
UI è‡ªåŠ¨æ›´æ–°
```

### 3. å®æ—¶æ›´æ–°ï¼ˆæ¶ˆæ¯ç¼–è¾‘ï¼‰

```
æœåŠ¡å™¨æ›´æ–°æ¶ˆæ¯
  â†“
Socket.IO å¹¿æ’­
  â†“
å‰ç«¯æ”¶åˆ°äº‹ä»¶
  â†“
handleUpdateMessage æ›´æ–°ç¼“å­˜
  â†“
UI è‡ªåŠ¨æ›´æ–°
```

---

## ğŸ“ äº‹ä»¶åå¯¹åº”å…³ç³»

### æœåŠ¡å™¨ç«¯å‘é€çš„äº‹ä»¶

| æ“ä½œ | äº‹ä»¶åæ ¼å¼ | ç¤ºä¾‹ |
|------|-----------|------|
| å‘é€æ–°æ¶ˆæ¯ | `channel:${channelId}:channel-messages` | `channel:channel-123:channel-messages` |
| æ›´æ–°æ¶ˆæ¯ | `channel:${channelId}:channel-messages:update` | `channel:channel-123:channel-messages:update` |

### å‰ç«¯ç›‘å¬çš„äº‹ä»¶

| å‚æ•° | äº‹ä»¶åæ ¼å¼ | ç¤ºä¾‹ |
|------|-----------|------|
| `addKey` | `channel:${chatId}:channel-messages` | `channel:channel-123:channel-messages` |
| `updateKey` | `channel:${chatId}:channel-messages:update` | `channel:channel-123:channel-messages:update` |

**é‡è¦**ï¼šå‰åç«¯äº‹ä»¶åå¿…é¡»å®Œå…¨åŒ¹é…ï¼

---

## ğŸ¯ ä¸€å¥è¯æ€»ç»“

> "ç”¨æˆ·æ“ä½œ â†’ HTTP è¯·æ±‚ â†’ æœåŠ¡å™¨ä¿å­˜æ•°æ®åº“ â†’ Socket.IO å¹¿æ’­ â†’ å‰ç«¯æ¥æ”¶äº‹ä»¶ â†’ æ›´æ–° React Query ç¼“å­˜ â†’ UI è‡ªåŠ¨æ›´æ–°"

---

## ğŸ“š ç›¸å…³æ–‡ä»¶

- **å‰ç«¯ Socket è¿æ¥**ï¼š`src/hooks/use-chat-socket-connection.ts`
- **æ•°æ®è·å–**ï¼š`src/hooks/use-chat-fetcher.ts`
- **æ¶ˆæ¯æ˜¾ç¤º**ï¼š`src/components/chat-messages.tsx`
- **æ¶ˆæ¯é¡¹**ï¼š`src/components/chat-item.tsx`
- **å‘é€æ¶ˆæ¯ API**ï¼š`src/pages/api/web-socket/messages/index.ts`
- **æ›´æ–°æ¶ˆæ¯ API**ï¼š`src/pages/api/web-socket/messages/[messageId].ts`
- **Socket.IO åˆå§‹åŒ–**ï¼š`src/pages/api/web-socket/io.ts`

---

## ğŸ’¡ å…³é”®ç†è§£

1. **HTTP è¯·æ±‚**ï¼šç”¨äºåˆå§‹åŠ è½½å’Œç”¨æˆ·æ“ä½œï¼ˆå‘é€ã€ç¼–è¾‘ã€åˆ é™¤ï¼‰
2. **Socket.IO**ï¼šç”¨äºå®æ—¶æ¨é€æ›´æ–°ï¼ˆæ–°æ¶ˆæ¯ã€æ¶ˆæ¯æ›´æ–°ï¼‰
3. **React Query**ï¼šç®¡ç†æ•°æ®ç¼“å­˜ï¼Œè‡ªåŠ¨å¤„ç† UI æ›´æ–°
4. **äº‹ä»¶ååŒ¹é…**ï¼šæœåŠ¡å™¨å‘é€çš„äº‹ä»¶åå¿…é¡»ä¸å‰ç«¯ç›‘å¬çš„äº‹ä»¶åå®Œå…¨ä¸€è‡´

---

## ğŸ”„ å®Œæ•´å¾ªç¯

```
åˆå§‹åŠ è½½ï¼ˆHTTPï¼‰
  â†“
æ˜¾ç¤ºæ¶ˆæ¯
  â†“
ç”¨æˆ·æ“ä½œï¼ˆHTTPï¼‰
  â†“
æœåŠ¡å™¨å¤„ç†
  â†“
Socket.IO å¹¿æ’­
  â†“
å‰ç«¯æ¥æ”¶ï¼ˆSocket.IOï¼‰
  â†“
æ›´æ–°ç¼“å­˜ï¼ˆReact Queryï¼‰
  â†“
UI æ›´æ–°
  â†“
ï¼ˆå¾ªç¯ç»§ç»­...ï¼‰
```

